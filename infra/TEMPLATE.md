# Проект {Project}

Шаблон инфраструктурного репозитория расположен в корпоративном [GitLab](https://gitlab.tn.ru/infra/template/) и в нем же описаны основные концепции

## Общие концепции
Работа с секретами описана в файле [SECRETS.md](SECRETS.md). 
- Секреты нужно настроить до начала работы и сразу после установки нового сервера
- Без этого сборка будет завершаться ошибкой публикации в docker registry

Работа Container Registry для хранения Docker образов описана в файле [REGISTRY.md](REGISTRY.md). 

Инструкции по настройке конкретных сред пишутся в индивидуальных файлах:
- Продуктивная среда в файле [PROD.md](PROD.md)
- Стэйджинг в файле [STAGE.md](STAGE.md)
- Тестовая среда в файле [TEST.md](TEST.md)

Учет задач по разработке {Project} ведется в ??? (???)

Список задач по улучшению ведется в GitHub Issues](https://github.com/ikashapov/infra-{Project}/issues)

### Репозитории

Используемые в проекте Git репозитории описываются в файле ```.build.repository```

### Переменные окружения

Общие параметры сборки описываются в файлах ```.build.* ```

Текущая среда описывается переменной DEPLOYMENT в файле [.build.deployment](.build.deployment) и в дальнейшем ссылки на нее идут через значение переменной ${DEPLOYMENT}

Типичные виды сред:
- prod - продуктив
- stage - стэйджинг для тестирования перед обновлением продуктива
- test - тестовая среда для проверки сборок

Но можно использовать необходимое количество сред, включая среды для разработчиков и интеграционные

Общие для всех сред переменные окружения располагаются в файлах ```.env.* ```

Индивидуальные переменные для сред описываются в файлах ```.env.*.${DEPLOYMENT} и .build.*.${DEPLOYMENT}```

Для каждой среды делается индивидуальный файл docker-compose имеющие имя: docker-compose.${DEPLOYMENT}.yml

### Патчи

Патчи общие для всех сред располагаются в папке [patches](patches/) и накладываются копированием файлов из этой папки в папки с репозиториями

Индивидуальные для конкретной среды патчи располагаются в папке ```patches.*.${DEPLOYMENT}```

Обычно туда кладутся файлы с сертификатами

В папке с патчами приходится держать пустые сборочные каталоги, т.к. из за [ошибки в docker-compose](https://github.com/isard-vdi/isard/issues/248) 
при запуске на основе ранее собранных образов будет ошибка вида ```ERROR: build path either does not exist```

### Генерация случайных паролей 
```bash
tr -dc A-Za-z0-9_ < /dev/urandom | head -c 10 | xargs
```

### Автоматизация развертывания
CI GitLab

### Установка CLI (yc) для управления Яндекс.Облако
https://cloud.yandex.ru/docs/cli/operations/install-cli

```bash
curl https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
```
